{% extends 'MSSCoreBundle:Home:base.html.twig' %}

{% block stylesheet %}
<link href="{{ asset('bundles/msscore/css/video-js.css') }}" rel="stylesheet">
<style type="text/css">
    body {
        margin-top: 50px; /* 50px is the height of the navbar - change this if the navbarn height changes */
    }

    .img-responsive, .thumbnail > img, .thumbnail a > img, .carousel-inner > .item > img, .carousel-inner > .item > a > img {
        height: 150px;
        width: 100%;
    }
    
    .portfolio-item {
        margin-bottom: 25px;
    }

    .full {
        -webkit-background-size: cover;
        -moz-background-size: cover;
        -o-background-size: cover;
        background-size: cover;
        width:100%;
        height:700px;
        background-color:#999999;
    }
    
    .inner-full {
        width:950px;
        height:550px;
    }
    
    .box {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: center;
        align-items: center;
    }
    
    .carousel {
        height:auto;
        width:100%;
    }
    
    .carousel-control{
      float:left;
      background: none !important; 
      text-shadow: none;
      opacity: 1;
      filter: alpha(opacity=100);
    }
    
    .carousel-control{
      float:right;
      background: none !important;
      text-shadow: none;
      opacity: 1;
      filter: alpha(opacity=100);
    }
    
    .carousel-control:hover, .carousel-control:focus {
      opacity: 1;
      filter: alpha(opacity=100);
    }
    
    .carousel .carousel-control { visibility: hidden; }
    .carousel:hover .carousel-control { visibility: visible; }
    
</style>
{% endblock %}

{% block javascript %}
<script src="{{ asset('bundles/msscore/js/video.js') }}"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script type="text/javascript">
$(document).ready(function() {
	$('#commentForm').submit(function(e) {
            e.preventDefault();
            
            $.ajax({
                type: "POST",
                url:  $('#commentForm').attr('action'),
                data: $(this).serialize(),
                cache: false,
                success: function(data) {
                    //console.log(data);
                    createComment(data);
                }
            });
        });
        
        $('#hiddenReplyForm').submit(function(e) {
            e.preventDefault();
            
            $.ajax({
                type: "POST",
                url:  $('#hiddenReplyForm').attr('action'),
                data: $(this).serialize(),
                cache: false,
                success: function(data) {
                    console.log(data);
                }
            });
        });
        
        $('#hiddenRepliesListForm').submit(function(e) {
            e.preventDefault();
            
            $.ajax({
                type: "POST",
                url:  $('#getAllRepliesForm').attr('action'),
                data: $(this).serialize(),
                cache: false,
                success: function(result) {
                    console.log(result.success);
                    createRepliesList(result);
                }
            });
        });
        
        $('#rateForm').submit(function(e) {
            e.preventDefault();
            
            $.ajax({
                type: "POST",
                url:  "{{url('mss_core_media_rate')}}",
                data: $(this).serialize(),
                cache: false,
                success: function(data) {
                    console.log(data);
                    if (!data.success){
                        alert(data.errormsg);
                        console.log(data.errormsg);
                    }
                }
            });
        });
        
    });

    $(function(){$('#rate a').hover(function(){
        console.log('aaa');    
        var id= $('span', this).attr('id');
        var counter = 1;

        $('span').each(function(i){
        if (id >= counter) {
            $('#'+counter).removeClass("glyphicon-star-empty");
            $('#'+counter).addClass("glyphicon-star");
        } else {
            $('#'+counter).removeClass("glyphicon-star");
            $('#'+counter).addClass("glyphicon-star-empty");
        }
        counter++;
        });
    });
    });
    
    $(function(){$('#rate a').click(function(){
            var id= $('span', this).attr('id');
            {% if type == 1%}
                {% set rate_mediaid = media[0].imageid %}
            {% elseif type == 2 %}
                {% set rate_mediaid = media[0].audioid %}
            {% elseif type == 3 %}
                {% set rate_mediaid = media[0].textid %}
            {% elseif type == 4 %}
                {% set rate_mediaid = media[0].vedioid %}
            {% endif %}
                
            $('#stars').val(id);
            $('#mtype').val("{{type}}");
            $('#mid').val("{{rate_mediaid}}");
            
            $('#rateForm').submit();
            return false;
    });
    });
    
    function createComment(obj){
	if(obj.success){
        var user = "{{ app.session.get('uname') }}";
        var picpath = "{{ asset('uploads/' ~ app.session.get('uprofile'))}}";
        var content = '<ul class="media-list">' + '<li class="media">' +
                      '<div class="media">' + '<a class="pull-left" href="#">' +
                      '<img class="media-object" width="80%" height="80%" src="' + picpath +'">' +
                      '</a>' + '<div class="media-body">' + '<h3 class="media-heading">' + user +
                      '</h3>' + '<h4>' + obj.content + '</h4>' + 
                      '<button class="btn-link" style="margin:0px; padding: 0px" onclick="$(\'.replyDialog\').toggle();">Reply</button>&nbsp;&nbsp;' + 
                      '<button class="btn-link" style="margin:0px;padding:0px" onclick="showRepliesList()">View all replies</button>' +
                      '<div class="replyDialog" style="margin-top:20px"><form><div class="form-group">' +
                      '<textarea class="form-control replyDialogContent" style="width:50%" rows="3"></textarea>'+
                      '</div><button type="submit" class="btn btn-primary" onclick="submitMyReply('+ obj.commentid +
                      ', $(\'.replyDialogContent\').val())">Submit</button></form></div><div class="repliesList></div>"';
        $('#commentsList').append(content);
        $('#comtcontent').val('');
        $('#commentsList .replyDialog').toggle();
	} else {
	alert('Please login first!');
	}
    }
    
    function submitMyReply(id, content){
        {% if type ==1 %}
        {% set action = path('mss_core_comment_reply', {'type': type, 'mediaid':media[0].imageid})%}
        {% elseif type==2 %}  
        {% set action = path('mss_core_comment_reply', {'type': type, 'mediaid':media[0].audioid})%}
        {% elseif type==3 %}
        {% set action = path('mss_core_comment_reply', {'type': type, 'mediaid':media[0].textid})%}
        {% elseif type==4 %}  
        {% set action = path('mss_core_comment_reply', {'type': type, 'mediaid':media[0].vedioid})%}
        {% endif %} 
         
        var action = "{{action}}"; 
        $('#hiddenReplyForm').attr('action', action);
        $('#hiddenReplyParent').val(id);
        $('#hiddenReplyContent').val(content);
        
        //$('#hiddenReplyForm').submit();
            
    }
    
    function showRepliesList(commentid){
        $('#hiddenRepliesListParent').val(commentid);
        $('#hiddenRepliesListForm').submit();
    }
    
    function createRepliesList(result){
        $('.allReplies'+result.parentid).append('<ul>');
        for(var i=0;i<result.data.length;i++){
            var tmp = '<li class="media">' +
                      '<div class="media">' +
                      '<a class="pull-left" href="#">'
                      '<img class="media-object" width="80%" height="80%" src="' + "{{ asset('uploads/')}}" + result.data[i].photopath +'">' +
                      '</a>' +
                      '<div class="media-body">' +
                      '<h3 class="media-heading">' + result.data[i].commenter + '</h3>' +
                      '<h4>' + result.data[i].content + '</h4>' +
                      '<input type="hidden" id="returnMyReplyToCommentID"/>' +
                      '</div></div></li>';
        $('.allReplies'+result.parentid).append(tmp);
        }
        $('.allReplies'+result.parentid).append('</ul>');
    }
</script>
{% endblock %}

{% block content %}
<div class="container" style="margin-top:50px; width: 100%;">
   
    <div class="row">
        <div class="full">
            <div class="box">
                <div width="25%" height="550px">
                <div class="row" style="margin-top:20px;">    
                {% if type == 1%}
                <img class="img-responsive inner-full" src="{{ asset('uploads/' ~ media[0].uploadpath) }}">
                {% elseif type == 3%}
                <object class="inner-full" type="application/pdf" data="{{ asset('uploads/' ~ media[0].uploadpath) }}">
                </object>
                {% else%}
                <video class="video-js vjs-default-skin" controls preload="auto" width="950px" height="550px"
                    data-setup="{}">
                  {% if type == 4 or type == 2%}  
                  <source src="{{ asset('uploads/' ~ media[0].uploadprefix ~ '.mp4') }}" type='video/mp4' />
                  <source src="{{ asset('uploads/' ~ media[0].uploadprefix ~ '.webm') }}" type='video/webm' />
                  {% endif %}
                </video>
                {% endif %}
                </div>
                <div class="row" style="justify-content: left;align-items: left;">
		<div class='col-md-10'>
		{% if type == 1 %}
		{% set dir = "images" %}
		{% endif %}
		{% if type == 2 %}
		{% set dir = "audios" %}
		{% endif %}
		{% if type == 3 %}
		{% set dir = "texts" %}
		{% endif %}
		{% if type == 4 %}
		{% set dir = "videos" %}
		{% endif %}
		<h3 style="color:white">
		{{ media[0].title }}&nbsp;&nbsp;
		Views: {{media[0].viewtimes}}&nbsp;&nbsp;
		Update date: {{media[0].updatetime.format('Y-m-d')}}
		<h2>
 		<a href="{{url('mss_core_user_channels', {'username': media[0].uploadname})}}">{{ media[0].uploadname }}</a>&nbsp;&nbsp;
		{% if app.session.get('uname') is not null %}
 		<a href="{{url('mss_core_media_download', {'uploadname': media[0].uploadname, 'dir':dir, 'name':name})}}">Downloads: {{media[0].downloadtimes}}</a>&nbsp;&nbsp;
		{% endif %}
		</h2>
		</h3>
		</div>
		<div class='col-md-2'>
                    <h2 id="rate" style="color:#ffffff;">
                        <a><span id="1" class="glyphicon glyphicon-star" style="font-size:60%; color:#aacd4e"></span></a>
                        <a><span id="2" class="glyphicon glyphicon-star" style="font-size:60%; color:#aacd4e"></span></a>
                        <a><span id="3" class="glyphicon glyphicon-star" style="font-size:60%; color:#aacd4e"></span></a>
                        <a><span id="4" class="glyphicon glyphicon-star" style="font-size:60%; color:#aacd4e"></span></a>
                        <a><span id="5" class="glyphicon glyphicon-star" style="font-size:60%; color:#aacd4e"></span></a>
                    </h2>
		</div>
                </div>

		<big><big>
		Description: {{media[0].description}}	
		</big></big>

                <div class="row" style="justify-content: left;align-items: left;">
                    {% if type == 2 or type == 4 %}
                    {% if app.session.get('uname') is not null%}
                    <div class="btn-group">
                        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                            Add to your playlist <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu" role="menu">
                            {% for item in playlist %}
                            {% if type == 2 %}
                            <li><a href="{{ path('mss_core_list_addToPlay', {'type':2, 'mediaid':media[0].audioid, 'keywords': media[0].keywords, 'plid': item.plid })}}">{{ item.title }}</a></li>
                            {% endif %}
                            {% if type == 4%}
                            <li><a href="{{ path('mss_core_list_addToPlay', {'type':4, 'mediaid':media[0].vedioid, 'keywords': media[0].keywords, 'plid': item.plid })}}">{{ item.title }}</a></li>
                            {% endif %}
                            {% endfor %}
                        </ul>
                    </div>
                    {% else %}
                    <a class="btn btn-default" href="{{ url('mss_core_list_play') }}">Add to playlist<span class="glyphicon glyphicon-chevron-right"></span></a><br><br>
                    {% endif %}
                    {% endif %}
                </div>    
                </div>
            </div>
        </div>
    </div>
</div>

<form id="rateForm" method ="POST"  data-async enctype="multipart/form-data" action="#">
    <input type="hidden" id="stars" name="stars"/>
    <input type="hidden" id="mtype" name="mtype"/>
    <input type="hidden" id="mid" name="mid"/>
</form>

<div style="margin-left:12%; margin-right:12%; margin-top:80px">
    
        {% if type == 1 or type == 4 %}
        <div class="row">
        <div class="col-md-12">
            <h1><small>RELATED MEDIA</small></h1>
            <hr class="featurette-divider" style="margin-top:0px; margin-bottom:50px;" >
            <div id="carousel-example-generic1" class="carousel slide">
            <!-- Wrapper for slides -->
            <div class="carousel-inner">
              
              {% set len = similars|length%}
              {% if len > 1 %}  
              {% set rows = (len/4)|round %}
              {% for i in range(0, rows-1) %}  
              {% if i == 0 %}  
              <div class="item active" style="background-color: #ffffff; height: auto;">
              {% else %}
              <div class="item" style="background-color: #ffffff; height: auto;">    
              {% endif %}    
                  <div class="row">
                      {% for j in range(0,3) %}
                      {% set index = i*4+j %}
                      {% if index < len%}
                      {% set image = similars[index] %}
                      <div class="col-sm-3 col-xs-6">
                          {% if type == 1 %}
                          <a href="{{ path('mss_core_cate_specific', {'type': 1, 'mediaid': image.imageid, 'keywords':image.keywords }) }}">
                            <img class="img-responsive" src="{{ asset('uploads/' ~ image.uploadpath) }}">
                          </a>
                          {% elseif type==4 %}
                          <a href="{{ path('mss_core_cate_specific', {'type': 4, 'mediaid': image.vedioid, 'keywords': image.keywords}) }}">
                            <img class="img-responsive" src="{{ asset('uploads/' ~ image.framepath) }}">
                          </a>
                          {% endif %}
                      </div>
                      {% endif %}
                      {% endfor %} 
                  </div>
              </div>
              {% endfor %}
              {% endif %}    
          </div>
            <!-- Controls -->
            <a class="left carousel-control" href="#carousel-example-generic1" data-slide="prev" style="left:-100px; color: #999999">
              <span class="glyphicon glyphicon-chevron-left"></span>
            </a>
            <a class="right carousel-control" href="#carousel-example-generic1" data-slide="next" style="right:-110px; color: #999999">
              <span class="glyphicon glyphicon-chevron-right"></span>
            </a>
        </div>
        </div>
        </div>
        </div>    
            
        {% elseif type == 2 %}
        <div class="row">
        <div class="col-md-12">
        <h1><small>RELATED MEDIA</small></h1>
        <hr class="featurette-divider" style="margin-top:0px; margin-bottom:50px;" >    
        {% for audio in similars %}
        {% if audio.audioid != media[0].audioid %}
        <div class="col-sm-3 col-xs-6">
            <div class="well">
            <h3>{{ audio.title }}</h3>
            <h4><a href="{{ path('mss_core_cate_specific', {'type': 2, 'mediaid': audio.audioid, 'keywords':audio.keywords}) }}">Listen <span class="glyphicon glyphicon-chevron-right"></span></a></h4>
            </div>
        </div>
        {% endif %}
        {% endfor %}
        </div>    
        </div>

        {% elseif type == 3 %}
        <div class="row">
        <div class="col-md-12">
        <h1><small>RELATED MEDIA</small></h1>
        <hr class="featurette-divider" style="margin-top:0px; margin-bottom:50px;" >      
        {% for text in similars %}
        {% if text.textid != media[0].textid %}
        <div class="col-sm-3 col-xs-6">
            <div class="well">
            <h3>{{ text.title }}</h3>
            <h4>
                <a href="{{ path('mss_core_cate_specific', {'type': 3, 'mediaid': text.textid, 'keywords': text.keywords }) }}">View <span class="glyphicon glyphicon-chevron-right"></span></a>
            </h4>
            </div>
        </div>
        {% endif %}
        {% endfor %}
        </div>
        </div>
        {% endif %}
</div>

<div style="margin-left:12%; margin-right:12%;">
    <div class="row">
    <div class="col-md-12">
    <h1><small>COMMENTS</small></h1>
    <hr class="featurette-divider" style="margin-top:0px; margin-bottom:50px;" >
    
    {% if comments is defined %}
    <ul class="media-list">
        {% for comment in comments %}
        <li class="media">
        <div class="media">
            <a class="pull-left" href="{{url('mss_core_user_channels', {'username':comment.commenter.username})}}">
                <img style="max-width:200px; max-height:100px" class="media-object" width="80%" height="80%" src="{{ asset('uploads/' ~ comment.commenter.photopath)}}">
            </a>
            <div class="media-body">
                <h3 class="media-heading"><a href="{{url('mss_core_user_channels', {'username':comment.commenter.username})}}">{{ comment.commenter.username }}</a></h3>
                <h4>{{ comment.content }} </h4>
                <button class="btn-link clReply" style="margin:0px; padding: 0px" onclick="$('.reply{{comment.commentid}}').toggle();">Reply</button>&nbsp;&nbsp;
                <button class="btn-link clView" style="margin:0px;padding:0px" onclick="showRepliesList({{comment.commentid}})" >View all replies</button>
                <div class="reply{{comment.commentid}}" style="margin-top:20px;">
                    <form>
                        <div class="form-group">
                            <textarea class="form-control" id="new_{{comment.commentid}}" style="width:50%" rows="3"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary" onclick="submitMyReply({{comment.commentid}}, $('#new_{{comment.commentid}}').val())">Submit</button>
                    </form>
                </div>
                <script type="text/javascript">
                    $('.reply{{comment.commentid}}').toggle();
                </script>
                <div class="allReplies{{comment.commentid}}"></div>
            </div>
        </div>
        </li>
        {% endfor %}
    </ul>
    {% endif %}
    
    
    <div id="commentsList"></div>    
    {% if app.session.get('uname') is empty %}
    <h1><small>PLEASE LOGIN FIRST<small></h1>
    {% else%}
    <h2><small>LEAVE YOUR COMMENT</small></h2>             
    {% if type ==1 %}
     <form id="commentForm" method ="POST"  data-async enctype="multipart/form-data" action="{{path('mss_core_comment_creat', {'type': type, 'mediaid':media[0].imageid})}}">
     {% elseif type==2 %}  
     <form id="commentForm" method ="POST"  data-async enctype="multipart/form-data" action="{{path('mss_core_comment_creat', {'type': type, 'mediaid':media[0].audioid})}}">
     {% elseif type==3 %}
     <form id="commentForm" method ="POST"  data-async enctype="multipart/form-data" action="{{path('mss_core_comment_creat', {'type': type, 'mediaid':media[0].textid})}}">
     {% elseif type==4 %}    
     <form id="commentForm" method ="POST"  data-async enctype="multipart/form-data" action="{{path('mss_core_comment_creat', {'type': type, 'mediaid':media[0].vedioid})}}">
     {% endif %}    
         <div class="form-group">
             <textarea class="form-control" name="comtcontent" id="comtcontent" style="width:50%" rows="3"></textarea>
         </div>
         <button type="submit" class="btn btn-primary" id="submitBtn">Submit</button>
     </form>  
    {% endif %}
          
         
    <div id="hiddenReplyDiv" class="hidden">
    <form id="hiddenReplyForm" action="" method ="POST"  data-async enctype="multipart/form-data" >
        <input name="commentid" id="hiddenReplyParent"/> 
        <textarea name="potentialreplycontent" id="hiddenReplyContent"></textarea>
    </form>   
    </div>
     
         
    <div id="hiddenRepliesListDiv" class="hidden">
    <form id="hiddenRepliesListForm" action="{{path("mss_core_comment_getreplies")}}" method ="POST"  data-async enctype="multipart/form-data" >
        <input type="hidden" name="commentidToReplies" id="hiddenRepliesListParent"/>
    </form>   
    </div>     
         
    </div>
    </div>
    
</div>

{% endblock %}





